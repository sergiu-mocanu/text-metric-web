{% extends 'base.html' %}
{% load tz %}

{% block content %}
<form method="POST">
    {% csrf_token %}

    <div class="section-title">Baseline Script:</div>
    <label>
        <textarea name="baseline_script" placeholder="Enter the reference script...">{{ baseline_script }}</textarea>
    </label>

    <div class="section-title">AI Script:</div>
    <label>
        <textarea name="ai_script" placeholder="Enter the generated script...">{{ ai_script }}</textarea>
    </label>

    <div class="section-title">Select Metrics:</div>
    <label><input type="checkbox" id="select_all"> Select All</label>
    <div class="checkbox-group">
        {% for m in available_metrics %}
            <label><input type="checkbox" name="metrics" value="{{ m }}" class="metric_checkbox"
                {% if m in selected_metrics %}checked{% endif %}> {{ m }}</label><br>
        {% endfor %}
    </div>

    <div class="buttons">
        <input type="submit" value="Compare">
        <button type="button" onclick="window.location.href=window.location.pathname">Reset</button>
    </div>
</form>

{% if error_message %}
    <p class="error">{{ error_message }}</p>
{% endif %}

{% if similarity_scores %}
    <div class="results">
        <h2>Results</h2>
        <ul>
            {%  for metric, score in similarity_scores.items %}
                <li><b>{{ metric }}</b>: {{ score }}</li>
            {% endfor %}
        </ul>
    </div>
    <pre id="chartData" style="display:none">{{ chart_data|safe }}</pre>
    <div class="chart-container" style="margin-top: 2em">
        <canvas id="metricsChart"></canvas>
    </div>
{% endif %}

<form method="get" class="filter-form">
    <label for="filter_metric">Show previous results for:</label>
    <select name="filter_metric" id="filter_metric" onchange="this.form.submit()">
        <option vlaue="All" {% if not selected_filter or selected_filter == 'All' %}selected{% endif %}>All</option>
        {%  for m in available_metrics %}
            <option value="{{ m }}" {%  if m == selected_filter %}selected{% endif %}>{{ m }}</option>
        {%  endfor %}
    </select>
</form>

{%  if previous_results %}
    <h3>Previous results</h3>
    <ul>
    {%  for r in previous_results %}
        <li>
            <strong>{{  r.created_at|localtime|date:"Y-m-d H:i" }}</strong><br>
            <em>Metrics:</em> {{ r.metrics_used }}<br>
            <em>Result:</em>
            <ul>
                {%  for key, value in r.results.items %}
                    <li>{{ key }}: {{ value }}</li>
                {% endfor %}<br>
            </ul>
        <em>Baseline script: </em>
        <div class="toggle-container">
            <pre class="excerpt">{{ r.baseline_script | truncatechars:120 }}</pre>
            <pre class="full-text" style="display:none;">{{  r.baseline_script }}</pre>
            <a href="#" class="toggle-link">Show more</a><br><br>
        </div>

        <em>AI script: </em>
        <div class="toggle-container">
            <pre class="excerpt">{{ r.ai_script | truncatechars:120 }}</pre>
            <pre class="full-text" style="display:none;">{{  r.ai_script }}</pre>
            <a href="#" class="toggle-link">Show more</a><br><br>
        </div>
        </li>
    {% endfor %}
    </ul>
{% endif %}
{% endblock %}